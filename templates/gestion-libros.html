<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/static/img/favicon.png" type="image/png">
  <title>Gesti√≥n de Libros</title>
  <link rel="stylesheet" href="/static/css/estilos.css">
</head>
<body>
  <header class="titulo">
    <h1>üìö Gesti√≥n de Libros</h1>
    <p>Agrega o elimina libros del cat√°logo</p>
    <a href="/panel" class="btn-volver" style="float:left; margin-top:-40px;">üè† Volver al Panel</a>
    <img src="/static/img/logo.png" alt="Logo Biblioteca Virtual" style="float:right; margin-top:-40px;">
  </header>

  <main>
    <section class="formulario-libro">
      <label for="seccion-selector"><b>Secci√≥n:</b></label>
      <select id="seccion-selector" class="seccion-selector">
        <option value="000">Secci√≥n 000</option>
        <option value="100">Secci√≥n 100</option>
        <option value="200">Secci√≥n 200</option>
        <option value="300">Secci√≥n 300</option>
        <option value="400">Secci√≥n 400</option>
        <option value="500">Secci√≥n 500</option>
        <option value="600">Secci√≥n 600</option>
        <option value="700">Secci√≥n 700</option>
        <option value="800">Secci√≥n 800</option>
        <option value="900">Secci√≥n 900</option>
      </select>
      <h2>Agregar nuevo libro</h2>
      <form id="formAgregarLibro" enctype="multipart/form-data">
        <input type="number" id="cantidad" placeholder="Cantidad" min="1" required>
        <input type="text" id="codigo" placeholder="C√≥digo" required>
        <input type="text" id="categoria" placeholder="Categor√≠a" required>
        <input type="text" id="nombre" placeholder="Nombre del libro" required>
        <input type="text" id="autor" placeholder="Autor" required>
        <input type="text" id="estado" placeholder="Estado" required>
        <input type="text" id="origen" placeholder="Origen" required>
        <input type="url" id="imagen" placeholder="URL de imagen de portada (opcional)">
        <input type="file" id="imagenArchivo" accept="image/*">
        <button type="submit">Agregar Libro</button>
      </form>
    </section>

    <section class="busqueda-libros">
        <p id="Sub">Buscar: Libro/Autor/Categor√≠a:</p>
  <input type="text" id="buscador" placeholder="Buscar por nombre, autor o categor√≠a">
</section>
    <section class="lista-libros">
      <h2>Libros actuales</h2>
      <div class="catalogo-grid">
        <div id="listaLibros"></div>
      </div>
    </section>
  </main>

  <footer>

  </footer>

  <script>
    // Obtener y mostrar libros
    let todosLosLibros = [];
    function cargarLibros(seccion) {
      fetch(`/api/libros/${seccion}`)
        .then(res => res.json().then(data => ({status: res.status, data})))
        .then(({status, data}) => {
          if (Array.isArray(data)) {
            todosLosLibros = data;
            mostrarLibros(data);
          } else if (data && data.error) {
            document.getElementById('listaLibros').innerHTML = `<li style="color:red">${data.error}</li>`;
            mostrarMensaje(data.error, 'error');
          } else {
            document.getElementById('listaLibros').innerHTML = '<li style="color:red">No se pudieron cargar los libros.</li>';
            mostrarMensaje('No se pudieron cargar los libros.', 'error');
          }
        })
        .catch(() => {
          document.getElementById('listaLibros').innerHTML = '<li style="color:red">No se pudieron cargar los libros.</li>';
          mostrarMensaje('No se pudieron cargar los libros.', 'error');
        });
    }

    function mostrarLibros(libros) {
      const contenedor = document.getElementById('listaLibros');
      contenedor.innerHTML = '';
      if (libros.length === 0) {
        contenedor.innerHTML = '<div>No hay libros registrados.</div>';
        return;
      }
      libros.forEach(libro => {
        const div = document.createElement('div');
        div.className = 'libro-preview';
        div.innerHTML = `
          <div class="libro-info">
            <h3>${libro.nombre}</h3>
            <p class="autor">${libro.autor}</p>
            <p class="categoria">${libro.categoria || ''}</p>
            <p class="cantidad"><b>Cantidad:</b> ${libro.cantidad}</p>
            <div class="acciones">
              <button onclick="eliminarLibro(${libro.id})">üóëÔ∏è Eliminar</button>
              <button onclick="editarLibro(${libro.id})">‚úèÔ∏è Editar</button>
            </div>
          </div>
        `;
        contenedor.appendChild(div);
      });
    }

    // Buscar libros
    document.getElementById('buscador').addEventListener('input', function () {
      const texto = this.value.toLowerCase();
      const filtrados = todosLosLibros.filter(libro =>
        (libro.nombre || '').toLowerCase().includes(texto) ||
        (libro.autor || '').toLowerCase().includes(texto) ||
        (libro.categoria || '').toLowerCase().includes(texto) ||
        (libro.codigo || '').toLowerCase().includes(texto) ||
        (libro.estado || '').toLowerCase().includes(texto) ||
        (libro.origen || '').toLowerCase().includes(texto)
      );
      mostrarLibros(filtrados);
    });

    // Al agregar libro, refrescar la lista y el buscador
    document.getElementById('formAgregarLibro').addEventListener('submit', function(e) {
      e.preventDefault();
      const seccion = document.getElementById('seccion-selector').value;
      const cantidad = document.getElementById('cantidad').value.trim();
      const codigo = document.getElementById('codigo').value.trim();
      const categoria = document.getElementById('categoria').value.trim();
      const nombre = document.getElementById('nombre').value.trim();
      const autor = document.getElementById('autor').value.trim();
      const estado = document.getElementById('estado').value.trim();
      const origen = document.getElementById('origen').value.trim();
      const imagenUrl = document.getElementById('imagen').value.trim();
      const imagenArchivo = document.getElementById('imagenArchivo').files[0];
      if (!cantidad || !nombre || !autor || !categoria || !codigo || !estado || !origen) return;
      const btn = this.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.textContent = 'Agregando...';

      const formData = new FormData();
      formData.append('cantidad', cantidad);
      formData.append('codigo', codigo);
      formData.append('categoria', categoria);
      formData.append('nombre', nombre);
      formData.append('autor', autor);
      formData.append('estado', estado);
      formData.append('origen', origen);
      if (imagenArchivo) {
        formData.append('imagenArchivo', imagenArchivo);
      } else if (imagenUrl) {
        formData.append('imagen', imagenUrl);
      }

      fetch(`/api/libros/${seccion}`, {
        method: 'POST',
        body: formData
      })
      .then(res => res.json().then(data => ({status: res.status, data})))
      .then(({status, data}) => {
        this.reset();
        document.getElementById('buscador').value = '';
        if (Array.isArray(data)) {
          todosLosLibros = data;
          mostrarLibros(data);
          mostrarMensaje('Libro agregado correctamente', 'success');
        } else if (data && data.error) {
          mostrarMensaje(data.error, 'error');
        } else {
          mostrarMensaje('Error al agregar libro', 'error');
        }
      })
      .catch(() => {
        mostrarMensaje('Error al agregar libro', 'error');
      })
      .finally(() => {
        btn.disabled = false;
        btn.textContent = 'Agregar Libro';
      });
    });

    // Mensaje de feedback
    function mostrarMensaje(msg, tipo) {
      let div = document.getElementById('mensaje-feedback');
      if (!div) {
        div = document.createElement('div');
        div.id = 'mensaje-feedback';
        div.style.position = 'fixed';
        div.style.top = '10px';
        div.style.right = '10px';
        div.style.zIndex = '9999';
        document.body.appendChild(div);
      }
      div.textContent = msg;
      div.style.background = tipo === 'success' ? '#4caf50' : '#f44336';
      div.style.color = 'white';
      div.style.padding = '10px 20px';
      div.style.borderRadius = '5px';
      div.style.boxShadow = '0 2px 8px rgba(0,0,0,0.2)';
      setTimeout(() => { div.textContent = ''; }, 2000);
    }

    // Eliminar libro
    function eliminarLibro(id) {
      const seccion = document.getElementById('seccion-selector').value;
      if (confirm('¬øSeguro que deseas eliminar este libro?')) {
        fetch(`/api/libros/${seccion}/${id}`, { method: 'DELETE' })
          .then(res => res.json())
          .then(() => cargarLibros(seccion));
      }
    }
    window.eliminarLibro = eliminarLibro;
    document.getElementById('seccion-selector').addEventListener('change', function () {
      cargarLibros(this.value);
    });

    // Funci√≥n para editar libro
    function editarLibro(id) {
      const libro = todosLosLibros.find(l => l.id === id);
      if (!libro) return;
      // Crear formulario flotante
      let formDiv = document.getElementById('form-editar-libro');
      if (formDiv) formDiv.remove();
      formDiv = document.createElement('div');
      formDiv.id = 'form-editar-libro';
      formDiv.style.position = 'fixed';
      formDiv.style.top = '50%';
      formDiv.style.left = '50%';
      formDiv.style.transform = 'translate(-50%, -50%)';
      formDiv.style.background = '#fff';
      formDiv.style.padding = '20px';
      formDiv.style.borderRadius = '8px';
      formDiv.style.boxShadow = '0 2px 16px rgba(0,0,0,0.3)';
      formDiv.style.zIndex = '10000';
      formDiv.style.maxWidth = '350px';
      formDiv.style.width = '90%';
      formDiv.style.overflowY = 'auto';
      formDiv.style.maxHeight = '90vh';
      formDiv.innerHTML = `
        <h3>Editar libro</h3>
        <form id="formEditarLibro" style="display:flex;flex-direction:column;gap:8px;">
          <input type="number" id="edit-cantidad" placeholder="Cantidad" min="1" value="${libro.cantidad || 1}" required>
          <input type="text" id="edit-codigo" placeholder="C√≥digo" value="${libro.codigo}" required>
          <input type="text" id="edit-categoria" placeholder="Categor√≠a" value="${libro.categoria}" required>
          <input type="text" id="edit-nombre" placeholder="Nombre del libro" value="${libro.nombre}" required>
          <input type="text" id="edit-autor" placeholder="Autor" value="${libro.autor}" required>
          <input type="text" id="edit-estado" placeholder="Estado" value="${libro.estado}" required>
          <input type="text" id="edit-origen" placeholder="Origen" value="${libro.origen}" required>
          <input type="url" id="edit-imagen" placeholder="URL de imagen de portada (opcional)" value="${libro.imagen || ''}">
          <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button type="submit">Guardar cambios</button>
            <button type="button" id="cancelar-edicion">Cancelar</button>
          </div>
        </form>
      `;
      document.body.appendChild(formDiv);
      document.getElementById('cancelar-edicion').onclick = () => formDiv.remove();
      document.getElementById('formEditarLibro').onsubmit = function(e) {
        e.preventDefault();
        const seccion = document.getElementById('seccion-selector').value;
        const cantidad = document.getElementById('edit-cantidad').value.trim();
        const codigo = document.getElementById('edit-codigo').value.trim();
        const categoria = document.getElementById('edit-categoria').value.trim();
        const nombre = document.getElementById('edit-nombre').value.trim();
        const autor = document.getElementById('edit-autor').value.trim();
        const estado = document.getElementById('edit-estado').value.trim();
        const origen = document.getElementById('edit-origen').value.trim();
        const imagen = document.getElementById('edit-imagen').value.trim();
        fetch(`/api/libros/${seccion}/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cantidad: Number(cantidad), codigo, categoria, nombre, autor, estado, origen, imagen })
        })
        .then(res => res.json().then(data => ({status: res.status, data})))
        .then(({status, data}) => {
          if (Array.isArray(data)) {
            todosLosLibros = data;
            mostrarLibros(data);
            mostrarMensaje('Libro editado correctamente', 'success');
            formDiv.remove();
          } else if (data && data.error) {
            mostrarMensaje(data.error, 'error');
          } else {
            mostrarMensaje('Error al editar libro', 'error');
          }
        })
        .catch(() => {
          mostrarMensaje('Error al editar libro', 'error');
        });
      };
    }
    window.editarLibro = editarLibro;
    document.getElementById('seccion-selector').addEventListener('change', function () {
      cargarLibros(this.value);
    });

    // Al cargar la p√°gina, mostrar la primera secci√≥n
    cargarLibros(document.getElementById('seccion-selector').value);
  </script>

</body>
</html>
