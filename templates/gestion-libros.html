<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="/static/img/favicon.png" type="image/png">
  <title>Gesti√≥n de Libros</title>
  <link rel="stylesheet" href="/static/css/estilos.css">
</head>
<body>
  <div id="navbar-container"></div>
  <header class="titulo">
    <h1>üìö Gesti√≥n de Libros</h1>
    <p>Agrega o elimina libros del cat√°logo</p>
    <a href="/panel" class="btn-volver">üè† Volver al Panel</a>
    <img src="/static/img/logo.png" alt="Logo Biblioteca Virtual" class="logo-header">
  </header>

  <main>
    <section class="formulario-libro">
      <label for="seccion-selector"><b>Secci√≥n:</b></label>
      <select id="seccion-selector" class="seccion-selector">
        <option value="000">Generalidades</option>
      <option value="100">Filosofia y Psicolog√≠a</option>
      <option value="200">Religi√≥n</option>
      <option value="300">Ciencias Sociales</option>
      <option value="400">Lenguas</option>
      <option value="500">Ciencias Naturales y Matem√°ticas</option>
      <option value="600">Tecnolog√≠a/Ciencias Aplicadas</option>
      <option value="700">Las Artes</option>
      <option value="800">Literatura y Ret√≥rica</option>
      <option value="900">Geograf√≠a e Historia</option>
      </select>
      <h2>Agregar nuevo libro</h2>
      <form id="formAgregarLibro" enctype="multipart/form-data">
        <input type="number" id="cantidad" class="input-form" placeholder="Cantidad" min="1" required>
        <input type="text" id="codigo" class="input-form" placeholder="C√≥digo" required>
        <input type="text" id="categoria" class="input-form" placeholder="Categor√≠a" required>
        <input type="text" id="nombre" class="input-form" placeholder="Nombre del libro" required>
        <input type="text" id="autor" class="input-form" placeholder="Autor" required>
        <input type="text" id="estado" class="input-form" placeholder="Estado" required>
        <input type="text" id="origen" class="input-form" placeholder="Origen" required>
        <input type="url" id="imagen" class="input-form" placeholder="URL de imagen de portada (opcional)">
        <input type="file" id="imagenArchivo" class="input-form" accept="image/*">
        <button type="submit" class="btn-agregar">Agregar Libro</button>
      </form>
    </section>

    <section class="busqueda-libros">
        <p id="Sub" class="subtitulo-busqueda">Buscar: Libro/Autor/Categor√≠a:</p>
        <input type="text" id="buscador" class="input-form" placeholder="Buscar por nombre, autor o categor√≠a">
    </section>
    <section class="lista-libros">
      <h2>Libros actuales</h2>
      <div id="indicador-resultados" style="margin-bottom:10px;color:#1976d2;font-weight:500;"></div>
      <div class="catalogo-grid" id="listaLibros"></div>
      <div id="paginacion-gestion" style="display:flex;justify-content:center;gap:8px;margin:2em 0;"></div>
    </section>
  </main>
  <script>
    // Cargar la barra de navegaci√≥n desde navbar.html
    fetch("/static/navbar.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("navbar-container").innerHTML = html;
      });
  </script>
  <footer class="footer">
    <span id="footer-msg">&copy; 2025 Biblioteca Virtual. Todos los derechos reservados.</span>
  </footer>

  <script>
    let todosLosLibros = [];
    let paginaActual = 1;
    let limitePorPagina = 50;
    let librosFiltradosGlobal = null;
    let buscando = false;

    function actualizarIndicadorResultados(total, inicio, fin, esBusqueda) {
      const el = document.getElementById('indicador-resultados');
      if (!el) return;
      if (buscando) {
        el.textContent = 'Buscando...';
        return;
      }
      if (total === 0) {
        el.textContent = esBusqueda ? 'No se encontraron resultados.' : 'No hay libros registrados.';
        return;
      }
      el.textContent = `Mostrando ${inicio + 1}-${Math.min(fin, total)} de ${total} ${esBusqueda ? 'resultados de b√∫squeda' : 'libros'}`;
    }

    function renderPaginacion(total, pagina, limite) {
      const paginacion = document.getElementById('paginacion-gestion');
      if (!paginacion) return;
      paginacion.style.display = 'flex'; // Siempre visible
      paginacion.innerHTML = '';
      const totalPaginas = Math.ceil(total / limite);
      // Si solo hay una p√°gina, igual muestra la barra pero deshabilitada
      // Bot√≥n anterior
      const btnAnt = document.createElement('button');
      btnAnt.textContent = 'Anterior';
      btnAnt.className = 'btn-paginacion';
      btnAnt.disabled = pagina <= 1 || totalPaginas <= 1;
      btnAnt.onclick = () => cambiarPagina(pagina - 1);
      paginacion.appendChild(btnAnt);
      // N√∫meros de p√°gina (m√°ximo 5)
      let inicio = Math.max(1, pagina - 2);
      let fin = Math.min(totalPaginas, pagina + 2);
      if (pagina <= 3) fin = Math.min(5, totalPaginas);
      if (pagina >= totalPaginas - 2) inicio = Math.max(1, totalPaginas - 4);
      for (let i = inicio; i <= fin; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = 'btn-paginacion';
        btn.disabled = i === pagina || totalPaginas <= 1;
        if (i !== pagina && totalPaginas > 1) btn.onclick = () => cambiarPagina(i);
        if (i === pagina) btn.classList.add('pagina-activa');
        paginacion.appendChild(btn);
      }
      // Bot√≥n siguiente
      const btnSig = document.createElement('button');
      btnSig.textContent = 'Siguiente';
      btnSig.className = 'btn-paginacion';
      btnSig.disabled = pagina >= totalPaginas || totalPaginas <= 1;
      btnSig.onclick = () => cambiarPagina(pagina + 1);
      paginacion.appendChild(btnSig);
    }

    function cambiarPagina(nuevaPagina) {
      paginaActual = nuevaPagina;
      mostrarLibrosPaginados();
    }

    // Cambia mostrarLibrosPaginados para paginar todosLosLibros sin filtrar por b√∫squeda
    function mostrarLibrosPaginados() {
      let librosParaPaginar = librosFiltradosGlobal !== null ? librosFiltradosGlobal : todosLosLibros;
      const total = librosParaPaginar.length;
      const inicio = (paginaActual - 1) * limitePorPagina;
      const fin = inicio + limitePorPagina;
      renderPaginacion(total, paginaActual, limitePorPagina);
      actualizarIndicadorResultados(total, inicio, fin, !!librosFiltradosGlobal);
      mostrarLibros(librosParaPaginar.slice(inicio, fin));
    }

    // Modifica cargarLibros para traer todos los libros de la secci√≥n (todas las p√°ginas) y paginar en frontend
    async function cargarLibros(seccion) {
      let pagina = 1;
      let librosAcumulados = [];
      let totalPaginas = 1;
      do {
        const res = await fetch(`/api/libros/${seccion}?page=${pagina}&limit=${limitePorPagina}`);
        const data = await res.json();
        if (data.error) break;
        librosAcumulados = librosAcumulados.concat(data.libros);
        totalPaginas = Math.ceil(data.total / data.limit);
        pagina++;
      } while (pagina <= totalPaginas);
      todosLosLibros = librosAcumulados;
      paginaActual = 1;
      librosFiltradosGlobal = null;
      mostrarLibrosPaginados();
    }

    function mostrarLibros(libros) {
      const contenedor = document.getElementById('listaLibros');
      contenedor.innerHTML = '';
      if (libros.length === 0) {
        contenedor.innerHTML = '<div>No hay libros registrados.</div>';
        return;
      }
      libros.forEach(libro => {
        const div = document.createElement('div');
        div.className = 'libro-preview';
        div.innerHTML = `
          <div class="libro-img">
            ${libro.imagen ? `<img src="${libro.imagen}" alt="Portada del libro">` : '<div class="img-placeholder">Sin imagen</div>'}
          </div>
          <div class="libro-info">
            <h3>${libro.nombre}</h3>
            <p class="autor">${libro.autor}</p>
            <p class="categoria">${libro.categoria || ''}</p>
            <p class="cantidad"><b>Cantidad:</b> ${libro.cantidad}</p>
            <div class="acciones-gestion">
              <button type="button" class="btn-editar" onclick="editarLibro(${libro.id})"><span style='vertical-align:middle;'>‚úèÔ∏è</span> Editar</button>
              <button type="button" class="btn-eliminar" onclick="eliminarLibro(${libro.id})"><span style='vertical-align:middle;'>üóëÔ∏è</span> Eliminar</button>
            </div>
          </div>
        `;
        contenedor.appendChild(div);
      });
    }

    // --- B√öSQUEDA Y PAGINACI√ìN GLOBAL COMO EN CAT√ÅLOGO ---
    function quitarTildes(str) {
      return (str || '').normalize('NFD').replace(/\u0300-\u036f/g, '').toLowerCase();
    }

    async function cargarTodosLosLibrosDeSeccion(seccion) {
      let pagina = 1;
      let librosAcumulados = [];
      let totalPaginas = 1;
      do {
        const res = await fetch(`/api/libros/${seccion}?page=${pagina}&limit=${limitePorPagina}`);
        const data = await res.json();
        if (data.error) break;
        librosAcumulados = librosAcumulados.concat(data.libros);
        totalPaginas = Math.ceil(data.total / data.limit);
        pagina++;
      } while (pagina <= totalPaginas);
      return librosAcumulados;
    }

    let textoBusqueda = '';
    document.getElementById('buscador').addEventListener('input', async function () {
      textoBusqueda = quitarTildes(this.value);
      if (textoBusqueda) {
        buscando = true;
        actualizarIndicadorResultados(0, 0, 0, true);
        const seccion = document.getElementById('seccion-selector').value;
        todosLosLibros = await cargarTodosLosLibrosDeSeccion(seccion);
        paginaActual = 1;
        buscando = false;
        librosFiltradosGlobal = todosLosLibros.filter(libro =>
          quitarTildes(libro.nombre).includes(textoBusqueda) ||
          quitarTildes(libro.autor).includes(textoBusqueda) ||
          quitarTildes(libro.categoria).includes(textoBusqueda) ||
          quitarTildes(libro.codigo).includes(textoBusqueda) ||
          quitarTildes(libro.estado).includes(textoBusqueda) ||
          quitarTildes(libro.origen).includes(textoBusqueda)
        );
        mostrarLibrosPaginados();
      } else {
        librosFiltradosGlobal = null;
        paginaActual = 1;
        mostrarLibrosPaginados();
      }
    });

    // Al agregar libro, refrescar la lista y el buscador
    document.getElementById('formAgregarLibro').addEventListener('submit', function(e) {
      e.preventDefault();
      const seccion = document.getElementById('seccion-selector').value;
      const cantidad = document.getElementById('cantidad').value.trim();
      const codigo = document.getElementById('codigo').value.trim();
      const categoria = document.getElementById('categoria').value.trim();
      const nombre = document.getElementById('nombre').value.trim();
      const autor = document.getElementById('autor').value.trim();
      const estado = document.getElementById('estado').value.trim();
      const origen = document.getElementById('origen').value.trim();
      const imagenUrl = document.getElementById('imagen').value.trim();
      const imagenArchivo = document.getElementById('imagenArchivo').files[0];
      if (!cantidad || !nombre || !autor || !categoria || !codigo || !estado || !origen) return;
      const btn = this.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.textContent = 'Agregando...';

      const formData = new FormData();
      formData.append('cantidad', cantidad);
      formData.append('codigo', codigo);
      formData.append('categoria', categoria);
      formData.append('nombre', nombre);
      formData.append('autor', autor);
      formData.append('estado', estado);
      formData.append('origen', origen);
      if (imagenArchivo) {
        formData.append('imagenArchivo', imagenArchivo);
      } else if (imagenUrl) {
        formData.append('imagen', imagenUrl);
      }

      fetch(`/api/libros/${seccion}`, {
        method: 'POST',
        body: formData
      })
      .then(res => res.json().then(data => ({status: res.status, data})))
      .then(({status, data}) => {
        this.reset();
        document.getElementById('buscador').value = '';
        if (data && Array.isArray(data.libros)) {
          // En vez de solo actualizar la lista local, recargar desde backend para asegurar persistencia
          cargarLibros(seccion);
          mostrarMensaje('Libro agregado correctamente', 'success');
        } else if (data && data.error) {
          mostrarMensaje(data.error, 'error');
        } else {
          mostrarMensaje('Error al agregar libro', 'error');
        }
      })
      .catch(() => {
        mostrarMensaje('Error al agregar libro', 'error');
      })
      .finally(() => {
        btn.disabled = false;
        btn.textContent = 'Agregar Libro';
      });
    });

    // Animaci√≥n suave para feedback
    function mostrarMensaje(msg, tipo) {
      let div = document.getElementById('mensaje-feedback');
      if (!div) {
        div = document.createElement('div');
        div.id = 'mensaje-feedback';
        div.className = 'mensaje-feedback';
        document.body.appendChild(div);
      }
      div.textContent = msg;
      div.className = 'mensaje-feedback ' + (tipo === 'success' ? 'success' : 'error');
      div.style.opacity = '0';
      div.style.transition = 'opacity 0.5s';
      setTimeout(() => { div.style.opacity = '1'; }, 10);
      setTimeout(() => { div.style.opacity = '0'; }, 1800);
      setTimeout(() => { div.textContent = ''; }, 2300);
    }

    // Eliminar libro
    function eliminarLibro(id) {
      const seccion = document.getElementById('seccion-selector').value;
      if (confirm('¬øSeguro que deseas eliminar este libro?')) {
        fetch(`/api/libros/${seccion}/${id}`, { method: 'DELETE' })
          .then(res => res.json())
          .then(() => cargarLibros(seccion));
      }
    }
    window.eliminarLibro = eliminarLibro;
    document.getElementById('seccion-selector').addEventListener('change', function () {
      cargarLibros(this.value);
    });

    // Funci√≥n para editar libro
    function crearFondoModalEdicion() {
      let fondo = document.getElementById('fondo-modal-edicion');
      if (!fondo) {
        fondo = document.createElement('div');
        fondo.id = 'fondo-modal-edicion';
        fondo.style.position = 'fixed';
        fondo.style.top = '0';
        fondo.style.left = '0';
        fondo.style.width = '100vw';
        fondo.style.height = '100vh';
        fondo.style.background = 'rgba(0,0,0,0.35)';
        fondo.style.zIndex = '9999';
        document.body.appendChild(fondo);
        fondo.onclick = () => {
          document.getElementById('form-editar-libro')?.remove();
          fondo.remove();
        };
      }
    }

    function eliminarFondoModalEdicion() {
      document.getElementById('fondo-modal-edicion')?.remove();
    }

    function editarLibro(id) {
      const libro = todosLosLibros.find(l => l.id === id);
      if (!libro) return;
      crearFondoModalEdicion();
      let formDiv = document.getElementById('form-editar-libro');
      if (formDiv) formDiv.remove();
      formDiv = document.createElement('div');
      formDiv.id = 'form-editar-libro';
      formDiv.className = 'form-editar-libro';
      formDiv.innerHTML = `
        <button id="cerrar-edicion-x" style="position:absolute;top:10px;right:16px;font-size:1.5em;background:none;border:none;cursor:pointer;color:#888;">&times;</button>
        <h3>Editar libro</h3>
        <form id="formEditarLibro" style="display:flex;flex-direction:column;gap:12px;" enctype="multipart/form-data">
          <input type="number" id="edit-cantidad" class="input-form" placeholder="Cantidad" min="1" value="${libro.cantidad || 1}" required>
          <input type="text" id="edit-codigo" class="input-form" placeholder="C√≥digo" value="${libro.codigo}" required>
          <input type="text" id="edit-categoria" class="input-form" placeholder="Categor√≠a" value="${libro.categoria}" required>
          <input type="text" id="edit-nombre" class="input-form" placeholder="Nombre del libro" value="${libro.nombre}" required>
          <input type="text" id="edit-autor" class="input-form" placeholder="Autor" value="${libro.autor}" required>
          <input type="text" id="edit-estado" class="input-form" placeholder="Estado" value="${libro.estado}" required>
          <input type="text" id="edit-origen" class="input-form" placeholder="Origen" value="${libro.origen}" required>
          <input type="file" id="edit-imagenArchivo" class="input-form" placeholder="imagen" value="${libro.imagen}" >
          <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button type="submit" class="btn-guardar">Guardar cambios</button>
            <button type="button" id="cancelar-edicion" class="btn-cancelar">Cancelar</button>
          </div>
        </form>
      `;
      document.body.appendChild(formDiv);
      document.getElementById('cerrar-edicion-x').onclick = () => { formDiv.remove(); eliminarFondoModalEdicion(); };
      document.getElementById('cancelar-edicion').onclick = () => { formDiv.remove(); eliminarFondoModalEdicion(); };
      document.getElementById('formEditarLibro').onsubmit = function(e) {
        e.preventDefault();
        const seccion = document.getElementById('seccion-selector').value;
        const cantidad = document.getElementById('edit-cantidad').value.trim();
        const codigo = document.getElementById('edit-codigo').value.trim();
        const categoria = document.getElementById('edit-categoria').value.trim();
        const nombre = document.getElementById('edit-nombre').value.trim();
        const autor = document.getElementById('edit-autor').value.trim();
        const estado = document.getElementById('edit-estado').value.trim();
        const origen = document.getElementById('edit-origen').value.trim();
        const imagenArchivo = document.getElementById('edit-imagenArchivo').files[0];
        const formData = new FormData();
        formData.append('cantidad', cantidad);
        formData.append('codigo', codigo);
        formData.append('categoria', categoria);
        formData.append('nombre', nombre);
        formData.append('autor', autor);
        formData.append('estado', estado);
        formData.append('origen', origen);
        if (imagenArchivo) {
          formData.append('imagenArchivo', imagenArchivo);
        } else {
          formData.append('imagen', '');
        }
        fetch(`/api/libros/${seccion}/${id}`, {
          method: 'PUT',
          body: formData
        })
        .then(res => res.json().then(data => ({status: res.status, data})))
        .then(({status, data}) => {
          if (data && Array.isArray(data.libros)) {
            cargarLibros(seccion);
            mostrarMensaje('Libro editado correctamente', 'success');
            formDiv.remove();
            eliminarFondoModalEdicion();
          } else if (data && data.error) {
            mostrarMensaje(data.error, 'error');
          } else {
            mostrarMensaje('Error al editar libro', 'error');
          }
        })
        .catch(() => {
          mostrarMensaje('Error al editar libro', 'error');
        });
      };
    }
    window.editarLibro = editarLibro;
    document.getElementById('seccion-selector').addEventListener('change', function () {
      cargarLibros(this.value);
    });

    // Al cargar la p√°gina, mostrar la primera secci√≥n
    cargarLibros(document.getElementById('seccion-selector').value);
  </script>

</body>
</html>
