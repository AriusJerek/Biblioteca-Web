<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Catálogo de Libros</title>
  <link rel="stylesheet" href="/static/css/estilos.css">
</head>
<body>
  <div id="navbar-container"></div>
  <h1>Catálogo de Libros</h1>

  <label for="seccion-selector"><b>Sección:</b></label>
  <select id="seccion-selector" class="seccion-selector">
    <option value="000">Sección 000</option>
    <option value="100">Sección 100</option>
    <option value="200">Sección 200</option>
    <option value="300">Sección 300</option>
    <option value="400">Sección 400</option>
    <option value="500">Sección 500</option>
    <option value="600">Sección 600</option>
    <option value="700">Sección 700</option>
    <option value="800">Sección 800</option>
    <option value="900">Sección 900</option>
  </select>
  <input type="text" id="buscador-libros" placeholder="Buscar libro, autor o categoría">
  <div class="catalogo-grid" id="libros"></div>
  
  <!-- Modal para detalles del libro -->
  <div id="modal-libro" class="modal-libro" style="display:none;">
    <div class="modal-libro-contenido">
      <span id="cerrar-modal-libro" class="cerrar-modal-libro">&times;</span>
      <div id="detalle-libro"></div>
    </div>
  </div>
  <style>
    .modal-libro {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;
    }
    .modal-libro-contenido {
      background: #fff; padding: 2em; border-radius: 8px; max-width: 400px; width: 90%; position: relative;
      box-shadow: 0 2px 16px rgba(0,0,0,0.2);
    }
    .cerrar-modal-libro {
      position: absolute; top: 10px; right: 16px; font-size: 2em; cursor: pointer; color: #888;
    }
    .modal-libro img { max-width: 120px; display: block; margin-bottom: 1em; }
    .modal-libro .img-placeholder { width: 120px; height: 160px; background: #eee; display: flex; align-items: center; justify-content: center; color: #888; margin-bottom: 1em; }
    .modal-libro .detalle-campo { margin-bottom: 0.5em; }
  </style>
  <script>
    fetch("/static/navbar.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("navbar-container").innerHTML = html;
    });
  </script>

  <script>
    let todosLosLibros = [];

    function cargarLibros(seccion) {
      // Obtener los libros desde la API
      fetch(`/api/libros/${seccion}`)
        .then(res => res.json())
        .then(data => {
          todosLosLibros = data;
          mostrarLibros(data);
        });
    }

    function mostrarLibros(libros) {
      const contenedor = document.getElementById('libros');
      contenedor.innerHTML = '';
      libros.forEach((libro, idx) => {
        const div = document.createElement('div');
        div.className = 'libro-preview';
        div.innerHTML = `
          <div class="libro-img">
            ${libro.imagen ? `<img src="${libro.imagen}" alt="Portada del libro">` : '<div class="img-placeholder">Sin imagen</div>'}
          </div>
          <div class="libro-info">
            <h3>${libro.nombre}</h3>
            <p class="autor">${libro.autor}</p>
            <p class="categoria">${libro.categoria || ''}</p>
          </div>
        `;
        // Evento para mostrar modal con detalles
        div.addEventListener('click', function() {
          mostrarModalLibro(libro);
        });
        contenedor.appendChild(div);
      });
    }

    function mostrarModalLibro(libro) {
      const modal = document.getElementById('modal-libro');
      const detalle = document.getElementById('detalle-libro');
      detalle.innerHTML = `
        <div style="text-align:center;">
          ${libro.imagen ? `<img src="${libro.imagen}" alt="Portada del libro">` : '<div class="img-placeholder">Sin imagen</div>'}
        </div>
        <h2>${libro.nombre}</h2>
        <div class="detalle-campo"><b>Autor:</b> ${libro.autor || ''}</div>
        <div class="detalle-campo"><b>Categoría:</b> ${libro.categoria || ''}</div>
        <div class="detalle-campo"><b>Código:</b> ${libro.codigo || ''}</div>
      `;
      modal.style.display = 'flex';
    }
    // Cerrar modal al hacer click en la X o fuera del contenido
    document.getElementById('cerrar-modal-libro').onclick = function() {
      document.getElementById('modal-libro').style.display = 'none';
    };
    document.getElementById('modal-libro').onclick = function(e) {
      if (e.target === this) this.style.display = 'none';
    };

    // Evento del selector de sección
    document.getElementById('seccion-selector').addEventListener('change', function () {
      cargarLibros(this.value);
    });

    // Evento del buscador
    document.getElementById('buscador-libros').addEventListener('input', function () {
      // Función para quitar tildes solo para comparar
      function quitarTildes(str) {
        return (str || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
      }
      const texto = quitarTildes(this.value);
      const filtrados = todosLosLibros.filter(libro =>
        quitarTildes(libro.nombre).includes(texto) ||
        quitarTildes(libro.autor).includes(texto) ||
        quitarTildes(libro.categoria).includes(texto)
      );
      mostrarLibros(filtrados); // Se muestran los datos originales, con tildes si las tienen
    });

    // Al cargar la página, mostrar la primera sección
    cargarLibros(document.getElementById('seccion-selector').value);
  </script>
</body>
</html>
